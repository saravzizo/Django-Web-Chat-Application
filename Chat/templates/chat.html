{% extends 'login.html' %}
{%block title%}Chat-App{% endblock %}
{% block nav %}
<a class="btn btn-sm btn-outline-danger text-decoration-none p-1" href="{% url 'logout' %}">Logout</a>
{% endblock %}

{% block content %}
<div class="d-flex mb-4 justify-content-evenly align-items-center">
    <div class=" shadow-lg m-5 bg-light rounded col-8 col-md-7 col-lg-5 col-xl-4 col-sm-8">
        <div class="d-flex flex-row justify-content-center align-items-center bg-secondary">
            <i class="py-3 fa-2x bi bi-person-square"></i>
            <p class="h4 px-2 m-0">{{username}} </p>
        </div>

        <div class="col">
            <!-- Chat box -->
            <div class="card">
                <div class="card-body ">
                    <div id="chatBox" class="shadow-lg d-flex flex-column" style="height: 300px; overflow-y: scroll;">
                        <!-- Chat messages will go here -->

                        {% for chat in chat_history %}
                        
                        <div class=" mx-2 my-2 rounded "style="width: fit-content;max-width: 65%;background-color: #b2bbba;">
                            <div class="m-0 px-2 pt-1">
                                
                               
                                <p class="mb-2 h6" style="font-size:smaller;">{{chat.user.username}}</p>
                                
                                <span class="my-2" style="font-size:small;">{{ chat.message }}</span>
                            </div>
                            <div >
                                <p class="text-muted m-0 mx-1" style="font-size:x-small;float: right;">{{chat.date | time}}</p>
                            </div>
                        </div>
                       
                        {% endfor %}


                    </div>
                </div>
                <div class=" ">
                    <!-- Message input -->
                    <form class="card-footer d-flex flex-row" method="post" action="">
                        {% csrf_token %}
                        {% for field in Message_field %}
                        {{ field }}
                    {% endfor %}

                        <button id="sendButton" type="submit" class="btn btn-success btn-sm mx-2">Send</button>
                    </form>

                </div>
            </div>
        </div>


    </div>
</div>

{{ username|json_script:"json-username" }}
{{loggedinUser|json_script:"loggedin-user" }}
{{common_room_name|json_script:"common-room-name" }}
<script>

    function scrollToBottom() {
        var chatBox = document.getElementById('chatBox');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    const userName = JSON.parse(document.getElementById('json-username').textContent);
    const loggedInUser = JSON.parse(document.getElementById('loggedin-user').textContent);
    const commonRoomName = JSON.parse(document.getElementById('common-room-name').textContent);
    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chat_'
        + userName
        + '/'

    );

    chatSocket.onopen = function (e) {
        console.log("Connection established");
    };

    chatSocket.onerror = function (e) {
        console.error('WebSocket error:', e);
    };

    chatSocket.onclose = function (e) {
        if (e.wasClean) {
            console.log('WebSocket closed cleanly, code: ' + e.code + ', reason: ' + e.reason);
        } else {
            console.error('WebSocket connection abruptly closed.');
        }
    };


    chatSocket.onmessage = function (e) {
        const data = JSON.parse(event.data);

        const chatBox = document.querySelector('#chatBox');
        const messageDiv = document.createElement('div');
       
        messageDiv.className = ' mx-2 my-2 rounded';
        messageDiv.style.width = 'fit-content';
        messageDiv.style.backgroundColor = '#b2bbba';
        messageDiv.style.float = 'right';
        messageDiv.style.maxWidth = '65%';

        if (data.message) {
            messageDiv.innerHTML = (
              
                '<div class="m-0 px-2 pt-1">'
                +'<p class="mb-2 h6" style="font-size:smaller;">'
                +data.logged
                +'</p>'
                +'<span class="my-2" style="font-size:small;">'
                +data.message
                +'</span></div><div >'
                            
                +'<p class="text-muted m-0 mx-1" style="font-size:x-small;float: right;">'
                +'{{current_time}}'
                +'</p></div></div>'
                
                );

            chatBox.appendChild(messageDiv);
            scrollToBottom(); 

        } else {
            alert('The message was empty!')
        }
        // Append the message to the chat box




    };

    var messageInput = document.getElementById('messageInput');
    var sendButton = document.getElementById('sendButton');
    // Get the form element
    
    const form = document.querySelector('form');
    form.addEventListener('submit', function (event) {
        event.preventDefault();
        const message = messageInput.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'logged': loggedInUser,
            'username':userName,
            

        }));
        messageInput.value = '';
        
    });


    
    scrollToBottom(); 

</script>


{% endblock %}